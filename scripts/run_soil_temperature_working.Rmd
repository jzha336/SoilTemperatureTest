---
title: "Run soil temperature model"
author: "Jingjing Zhang"
date: "2024-09-03"
output: html_document
mainfont: Times New Roman
fig_caption: yes
fontsize: 12pt
linkcolor: black
urlcolor: black
citecolor: black
geometry: margin = 1.25in
theme: yeti
toc_depth: 4
highlight: tango
link-citations: no
lof: yes
lot: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(dplyr)
library(gsubfn)
library(ggplot2)

here::here()
# if there are data and outputs involved, then can also specify it.
# E.g., Define file paths
  # data_path <- here::here("data", "mydata.csv")
  # output_path <- here::here("output", "results.csv")
  # # Load data using the here::here() paths
  # my_data <- read.csv(data_path)
  # head(my_data)
  # # Process data and save results using the here::here() paths
  # write.csv(my_data, output_path)

source(here("R","snowcovercalculator_working.r"))
source(here("R","stmpsimcalculator_working.r"))
source(here("R","SoilTemperatureComponent_working.r"))
```

## Soil temperature model
write the scientific descriptions of the model here, such as background, model description and expected outcomes

```{r load weather data }
file_lines<- readLines("../data/queenstown.txt")
weather <- read.table("../data/queenstown.txt", skip = 8, header = FALSE)
weather_info<-readLines("../data/queenstown.txt")[1:6]

# Define the first two rows representing column names and units
column_names <- read.table(text = file_lines[7:8], header = FALSE, stringsAsFactors = FALSE) %>%
                { paste(.[1, ], .[2, ], sep = "") }
# Combine the column names with the units
colnames(weather) <- column_names
head(weather)
weather <- weather[which(weather$`year()` == c(2000, 2001)),]
```

```{r load parameter}

parameter <- read.table("../data/ParamTest.txt", sep = ",", skip = 1)
# cCarbonContent, 2.0
# cAlbedo, 0.5
# cAverageGroundTemperature, 5.69
# cAverageBulkDensity, 1.2
# cDampingDepth, 6.0
# cSoilLayerDepth, 0.1, 0.15, 0.25, 0.25, 0.25

parameter <- readLines("../data/ParamTest.txt")[-1]  # Skip the first line
parameter_info<-readLines("../data/ParamTest.txt")[1]
print(paste("load", parameter_info, "as input data"))

parameters <- list()



for (line in parameter) {
  parts <- strsplit(line, ",\\s*", fixed = FALSE)[[1]]
  param_name <- parts[1]
  if (length(parts) > 2) {
    param_value <- as.numeric(parts[-1])  
  } else {
    param_value <- as.numeric(parts[2]) 
  }
  parameters[[param_name]] <- param_value
}

print(parameters)
```

```{r initialisation}
soil_layers_no = length(parameters$cSoilLayerDepth)

init_snowcovercalculator_value<-init_snowcovercalculator(
  cCarbonContent = parameters$cCarbonContent,
         cInitialAgeOfSnow = 0,
         cInitialSnowWaterContent = 0,
         Albedo = parameters$cAlbedo,
         iTempMax = weather$`maxt(oC)`[1],
         iTempMin = weather$`mint(oC)`[1],
         iRadiation = weather$`radn(MJ/m^2)`[1],
         iRAIN = weather$`rain(mm)`[1],
         iCropResidues = 0,
         iPotentialSoilEvaporation = 0.6,# APSIM calculate could be in weather data, use 0.6
         iLeafAreaIndex = 0,
         iSoilTempArray = rep(0,soil_layers_no))# 0,0,0,0,0 - can be read off from the parameter - soil layer depth



init_stmpsimcalculator_value<-init_stmpsimcalculator(
         cSoilLayerDepth = parameters$cSoilLayerDepth,
         cFirstDayMeanTemp = mean(weather$`maxt(oC)`[1], weather$`mint(oC)`[1]), # first day from weather average between minT and maxT
         cAVT = parameters$cAverageGroundTemperature, #cAverageGroundTemperature
         cABD = parameters$cAverageBulkDensity, #cAverageBulkDensity
         cDampingDepth = parameters$cDampingDepth, #cDampingDepth
         iSoilWaterContent = 200, # Could be in weather data, use 200
         iSoilSurfaceTemperature = rep(mean(weather$`maxt(oC)`[1], weather$`mint(oC)`[1]), soil_layers_no)# a array of cFirstDayMeanTemp with no. of layers
         )

```

# Run Simulations
Here we use the loaded data and parameters to run the simulations.

```{r initial conditions}
# first combine the initail conditions interested
  initial_conditions <- list(
    pInternalAlbedo = init_snowcovercalculator_value$pInternalAlbedo,
    SnowWaterContent = init_snowcovercalculator_value$SnowWaterContent,
    SoilSurfaceTemperature = init_snowcovercalculator_value$SoilSurfaceTemperature,
    AgeOfSnow = init_snowcovercalculator_value$AgeOfSnow,
    SoilTempArray = init_stmpsimcalculator_value$SoilTempArray,
    rSoilTempArrayRate = init_stmpsimcalculator_value$rSoilTempArrayRate,
    pSoilLayerDepth = init_stmpsimcalculator_value$pSoilLayerDepth
  )

initial_conditions
```

```{r run simulations }
# Sequential simulation using initial values calculated earlier
simulation<-model_soiltemperature (initial_conditions, weather, parameters)
```

```{r plot simualtion results, e = F}
simulation_plot <-data.frame (Time = weather$Date,
  SoilSurfaceTemperature = simulation$SoilSurfaceTemperature2,
  SnowWaterContent = simulation$SnowWaterContent
)

ggplot(simulation_plot, aes(x = Time)) +
  geom_line(aes(y = SoilSurfaceTemperature, color = "Soil Temperature")) +
  #geom_line(aes(y = SnowWaterContent, color = "Snow Water Content")) +
  labs(title = "Simulated Soil Temperature Over Time", y = "Value", x = "Date") +
  theme_minimal()
```


```{r alternative }
init_snowcovercalculator <- function (cCarbonContent, cInitialAgeOfSnow, cInitialSnowWaterContent, Albedo, iTempMax, iTempMin) {
    SnowCoverArray <- numeric(length(iTempMax))
    
    # Compute snow cover based on temperature difference
    for (day in 1:length(iTempMax)) {
        temp_diff <- iTempMax[day] - iTempMin[day]
        
        # Simulate snow cover based on temperature and albedo
        snow_melt_factor <- temp_diff * Albedo
        
        # Handle each day's snow water content separately
        if (!is.na(cInitialSnowWaterContent[day])) {
            SnowCoverArray[day] <- max(cInitialSnowWaterContent[day] - snow_melt_factor, 0) # Ensure no negative snow cover
        } else {
            SnowCoverArray[day] <- 0
        }
        
        # Update age of snow (for future improvements)
        cInitialAgeOfSnow <- cInitialAgeOfSnow + 1
    }
    
    return(SnowCoverArray)
}

snow_cover <- init_snowcovercalculator(
  cCarbonContent = parameters$cCarbonContent,
  cInitialAgeOfSnow = 0,
  cInitialSnowWaterContent = 0,
  Albedo = parameters$cAlbedo,
  iTempMax = weather$`maxt(oC)`,
  iTempMin = weather$`mint(oC)`
)


init_SoilTemperatureComponent <- function (cCarbonContent, cAverageBulkDensity, cAverageGroundTemperature, iSoilWaterContent, iSoilSurfaceTemperature) {
  SoilTempArray <- vector()
  for (layer in 1:length(iSoilSurfaceTemperature)) {
    temp_variation <- cAverageGroundTemperature + (iSoilSurfaceTemperature[layer] * cAverageBulkDensity) / (1 + iSoilWaterContent)
    SoilTempArray[layer] <- temp_variation
  }
  return(SoilTempArray)
}

# Soil Temperature Simulation
init_stmpsimcalculator <- function (cSoilLayerDepth, cFirstDayMeanTemp, cAVT, cABD, cDampingDepth, iSoilWaterContent, iSoilSurfaceTemperature) {
  SoilTempArray <- vector()
  for (layer in 1:length(cSoilLayerDepth)) {
    SoilTempArray[layer] <- cFirstDayMeanTemp + (cAVT - iSoilSurfaceTemperature[layer]) * exp(-cABD * layer / cDampingDepth)
  }
  return(SoilTempArray)
}

cFirstDayMeanTemp <- (weather$`maxt(oC)` + weather$`mint(oC)`) / 2

# Initialize soil temperature simulation using the corrected mean temperature
soil_temp <- init_stmpsimcalculator(
    cSoilLayerDepth = parameters$cSoilLayerDepth,
    cFirstDayMeanTemp = cFirstDayMeanTemp[1],  # Use the first day's mean temperature
    cAVT = parameters$cAverageGroundTemperature,
    cABD = parameters$cAverageBulkDensity,
    cDampingDepth = parameters$cDampingDepth,
    iSoilWaterContent = 200,
    iSoilSurfaceTemperature = rep(cFirstDayMeanTemp[1], length(parameters$cSoilLayerDepth))
)


simulation_results <-data.frame()
# Or else could be:
for (day in 1:nrow(weather)) {
    # Sequentially update soil temperature and snow cover
    snow_cover_day <- snowcovercalculator2(
        cCarbonContent = parameters$cCarbonContent,
        cInitialAgeOfSnow = 0,
        cInitialSnowWaterContent = 0, # Use the current day's snow water content
        Albedo = parameters$cAlbedo,
        iTempMax = weather$`maxt(oC)`[day],
        iTempMin = weather$`mint(oC)`[day]
    )
    
    soil_temp_day <- init_stmpsimcalculator(
        cSoilLayerDepth = parameters$cSoilLayerDepth,
        cFirstDayMeanTemp = (weather$`maxt(oC)`[day] + weather$`mint(oC)`[day]) / 2,
        cAVT = parameters$cAverageGroundTemperature,
        cABD = parameters$cAverageBulkDensity,
        cDampingDepth = parameters$cDampingDepth,
        iSoilWaterContent = 200,
        iSoilSurfaceTemperature = rep(soil_temp[1], length(parameters$cSoilLayerDepth)) # Use previous iteration's result
    )
    
    # Append results to the dataframe
    simulation_results[day, "SoilSurfaceTemperature"] <- soil_temp_day[1]
}
simulation_results$SnowWaterContent <- simulation$SnowWaterContent
```

```{r some dummy plots}
# let's test the plotting function
# Set seed for reproducibility
set.seed(42)

weather$Date <- as.Date(weather$day - 1, origin = paste0(weather$year, "-01-01"))
simulation_df <- data.frame(
  Time = weather$Date, 
  SoilSurfaceTemperature = simulation_results$SoilSurfaceTemperature,
  SnowWaterContent = simulation_results$SnowWaterContent
)

simulation_df$MeanTemp<-(weather$`maxt(oC)` + weather$`mint(oC)`)/2


# Plot 1: Simulated Soil and Snow Conditions Over Time
library(reshape2)
simulation_melted <- melt(simulation_df, id.vars = "Time", variable.name = "Variable", value.name = "Value")

# Create a ggplot with three panels (one for each variable)
ggplot(simulation_melted, aes(x = Time, y = Value, color = Variable)) +
  geom_line() +
  facet_grid(Variable ~ ., scales = "free_y") +  
  labs(x = "Date", y = "Value", title = "Simulated Soil and Snow Conditions Over Time") +
  theme_minimal() +
  theme(legend.position = "none",
        panel.grid.major = element_blank()) +  
  scale_color_manual(values = c("#a7ba42", "#95ccba", "#ffdede", "#ff0000")) +  # Added color for MaxTemperature
  theme(strip.text = element_text(size = 10, face = "bold"))
```

```{r plot1_2}

temp_df <- data.frame(
  Time = simulation_df$Time,
  SoilSurfaceTemperature = simulation_df$SoilSurfaceTemperature,
  MeanTemperature = simulation_df$MeanTemp,
  sst<-simulation$SoilSurfaceTemperature
)

temp_melted <- melt(temp_df, id.vars = "Time", variable.name = "Temperature", value.name = "Value")

ggplot(temp_melted, aes(x = Time, y = Value, color = Temperature)) +
  geom_line() +
  labs(x = "Date", y = "Temperature (°C)", title = "Soil Surface Temperature and mean Temperature Over Time") +
  theme_minimal() +
  theme(panel.grid.major = element_blank()) +  
  scale_color_manual(values = c("#a7ba42", "#f2cc84", "red")) +  # Customize colors for the two lines
  theme(legend.title = element_blank(), strip.text = element_text(size = 10, face = "bold"))
```


```{r plot2}
# Plot 2: Weather Data Over Time
weather_melted <- melt(weather[, c(4:6, 9)], id.vars = "Date", variable.name = "Variable", value.name = "Value")


ggplot(weather_melted, aes(x = Date, y = Value, color = Variable)) +
  geom_line() +
  facet_grid(Variable ~ ., scales = "free_y", switch = "y") +  
  labs(x = "Date", y = NULL, title = "Weather Data Over Time") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),   
    panel.grid.minor = element_blank(),  
    strip.text.y = element_text(size = 12, face = "bold"), 
    axis.title.y = element_blank(),  
    legend.position = "none",       
    strip.placement = "outside",     
    axis.text.y = element_blank(),   
    axis.ticks.y = element_blank(), 
    panel.spacing = unit(1, "lines")  
  ) +
  scale_color_manual(values = c("#a7ba42", "#95ccba", "#ffdede"))
```

```{r plot3}
data <- data.frame(
  SnowWaterContent = simulation$SnowWaterContent,
  radn = weather$radn,
  wind = weather$wind
)

# Reshape the data for plotting
data_melted <- melt(data, id.vars = "SnowWaterContent", variable.name = "ClimateVariable", value.name = "Value")

ggplot(data_melted, aes(x = Value, y = SnowWaterContent, color = ClimateVariable)) +
  geom_point() +
  facet_grid(ClimateVariable ~ ., scales = "free_x", switch = "x") +  
  labs(x = "Climate Variables", y = "Snow Water Content", title = "Influence of Climate Variables on Snow Water Content") +
  theme_minimal() +
  theme(
    panel.grid.major = element_blank(),   
    panel.grid.minor = element_blank(),   
    strip.text.x = element_text(size = 12, face = "bold"),  
    axis.title.x = element_blank(), 
    strip.placement = "outside",    
    panel.spacing = unit(1, "lines") 
  ) +
  scale_color_manual(values = c("purple", "orange"))  
```
